# 220404 kubernetes / Docker

# 1. kubernetes

**컨테이너**화 애플리케이션을 대규모로 **배포**, Deployment(**デプロイ**), **관리**할 수 있는 오픈소스 **소프트**웨어.

**애플리케이션** ↔ **컨테이너 서비스**(구글 단독으로 수십억 개를 제공할 정도로 많음) 간 **연결**을 돕고 **자동화**하는 솔루션

- EC2 등의 컴퓨팅 인스턴트에서 **클러스터**를 관리 (컴퓨터와 컨테이너의 리소스 요건에 맞춤)
    - EC2(Amazon Elastic Compute Cloud) : 인스턴스 / 프로세서 / 네트워크 / 오퍼레이팅시스템 / 구입모델 등을 다양하게 제공하는 플래폼.
- 리소스 요건에 바탕하여 클러스터로 pod 자동 개시
- pod 또는 pod가 실행 중인 인스턴스에 장해 발생 시, pod을 **자동 재개**
- 각 포트에 IP주소, DNS명을 할당하여, 서비스 간 또는 외부 트래픽 간을 **연결**

유저는 **pod**(팟, 하나 또는 여러 컨테이너가 실행되는 논리그룹)을 실행/스케일링 가능.

- 하나 또는 여러 **컨테이너**를 pod으로 실행하고 규모 조절 가능.

**컨트롤 플레인 소프트웨어**(control plane software)가 관리하는 것

1. pod을 언제, 어디서 실행할지
2. pod의 루틴
3. pod의 규모

## 1-1. Cluster (クラスター) & Components (コンポーネント / 構成物)

클러스터란, 컨테이너화한 애플리케이션을 실행하는 노드의 집합체.

마스터(컨트롤플레인) / 워커(노드)의 **2종류** **컴포넌트로 구성**됨. (**①+②＝kubernetes Cluster)**

### ① Control Planes (コントロールプレーン)

= Admin, Master, **Master Node(マスターノード)**

동작을 담당. kubernetes의 심장.

1. **kube-api-server** : 모든 기능이 연계하는 **축**. 실행명령을 받고 노드를 움직임.
    
    소프트웨어는 API Server를 축으로 컨테이너로서 동작함. kubernetes **API를 공개**하는 **API 서버**.
    
2. etcd : kubernetes 클러스터의 정보를 보존하는 곳. 클러스터IP정보, kubelets의 정보 등 보관.
    
    (key / value store)
    
3. **kube-schedular** : 컨테이너의 배치 관리 및 실행 관리 (어느 노드에 컨테이너를 배치할지)
4. kube-controller-manager : 조작 전반 담당. (pod의 기동, 장해 검지)
5. cloud-controller-manager : 크라우드 (AWS, GCP 등) 기능과 연계
    - controller : 컨테이너를 묶는 단위 등에서 부족한 것을 생성함.

### ② Nodes (ノード)

= Worker, **Worker Node(ワーカーノード)**

컨테이너가 동작하는 환경(물리서버, 가상서버 다수를 의미)

1. **kubelet** : **①컨트롤 플레인 ↔ ②노드 연결**하는 프로세스. API를 이용해 주고받음.
    
    컨테이너의 기동/정지 등을 명령. kubectl(커맨드라인 툴) 포함
    
2. kube-proxy : 노드 상의 컨테이너와 통신하기 위해 특수한 행동(iptable 추가/변경 등)을 해줌.
3. **container runtime**(コンテナランタイム) : **컨테이너 실행**에 필요한 소프트웨어. 컨테이너를 움직임. (예: **Docker**, containerd)
4. 이외 네트워킹, OS가 포함.

## 1-2. Resources (リソース)

kubernetes가 **컨테이너를 관리**하기 위해 OS의 기능, iptables, Docker 등 콘테이너의 기능을 추상화하여 관리.

OS의 기능을 사용하여 ルール을 추가하는 것임.

관리를 위해 정의한 오브젝트이므로, OS상의 실체는 다를 수 있음.

**※ 대표적인 리소스**

1. **Nodes**(ワーカーノード) : 컨테이너가 동작하는 각 머신을 관리
2. **pod**(≒container) : kubernetes에서는 pod이 최소 단위로, 컨테이너를 pod리소스로 취급함.
    - pod에는 **복수의 컨테이너**를 넣을 수 있음.
    - 수정 시 기능 정지 범위가 커지지 않게 하기 위해, **1컨테이너 = 1기능**으로 하는 편이 좋음.
    - pod에 포함되는 것
        - Container(コンテナ―) 및 컨테이너에 부속된 정보.
        - Networking(pod의 IP주소) : pod 내 컨테이너는 같은 IP주소를 공유하지만, 포트 번호는 달라야 함
        - 공유 스토리지
3. **ReplicaSet** : pod의 **레플리카 작성**.
    - **지정된 수의 pod**를 계속적으로 **유지**하는 리소스.
        - replica = 3 으로 지정 시, 같은 pod이 3개 기동
    - kubernetes의 기능 중 하나인 “컨테이너 장해 시 **자동으로 복구**”를 실현하는 기능.
4. **Deployment**(デプロイ) : 복수의 ReplicaSet를 관리하여, 롤링업데이트 & 롤백 등 디플로이를 관리.
    - 예) pod을 새 버전으로 바꿀 때.
        1. 새 ReplicaSet를 작성
        2. 새 ReplicaSet가 휘하에 새 pod를 서서히 작성
        3. 새 pod가 서서히 작성되면서 동시에, 이전의 ReplicaSet 휘하의 pod을 하나씩 점점 삭제)
    - 업데이트 및 롤백 시 가동시간을 유지할 수 있음.
5. **Service** : pod의 엔드 포인트를 할당(割り当て). 포트를 지정해서 컨테이너에 통신함.
    - kubernetes 클러스터 내/외에서 통신하기 위한 **IP주소 할당**
    - pod에 가해지는 **부하 분산**
        - 예) 외부 → LoadBalancer →(부하분산1)→ NodePort →(부하분산2)→ pod
    - 대표적인 3개 타입
        
        ① ClusterIP : 클러스터 내에서만 소통 가능한 IP(워커 노드 내 pod 간의 통신)
        
        ② NodePort : 다른 서버에서도(kubernetes 클러스터 외) 소통 가능한 IP
        
        ③ LoadBalancer(대 프로드 밸런서) : 바깥과 연결되는 가상IP를 払い出せる仕組み
        

## kubernetes 정리와 예시

### 정리

1. **Components** : 클러스터(노드의 집합체)의 구성물. 마스터노드(컨트롤플레인)/워커노드 2종류가 있음.
    1. API Server : 마스터노드(컨트롤플레인)에서, 모든 기능/컨테이너가 연계하는 축. 
    2. Controller-manager : 마스터노드(컨트롤플레인)에서, pod의 기동/장해검지 등 조작 전반 담당.
    3. kube-proxy : 워커노드에서, 컨테이너와 통신하기 위한 특수한 기능 수행.
    4. kubelet : 워커노드에서, 마스터노드(컨트롤플레인)와 워커노드를 API를 이용해 연결하는 프로세스.
2. **Resources** : kubernetes가 컨테이너의 기능을 추상화시켜 관리하는 것.
    1. Service : pod의 IP주소 할당 및 부하 분산
    2. Deployment : 복수의 ReplicaSet을 관리하여, 롤링업데이트&롤백 등의 관리
    3. Pod : 하나 또는 여럿의 container
    4. Node : 워커노드, 컨테이너가 동작하는 각 머신을 관리
3. **Software**
    1. Docker
    2. iptables

### 예시1 : Nginx Pod를 기동하는 순서

1. PC에서 kube-api-server로 pod작성을 의뢰
2. kube-controller-manager가 api-server의 변화 감지 → 다른 api를 호출
3. kube-schedular가 api-server의 변화 감지 → pod를 어느 워커노드에 배치할지 지정
4. 워커노드의 kubelet이 마스터노드(컨트롤플레인)의 api-server의 변화 감지 → pod작성 의뢰 취득
5. kubelet이 Docker(컨테이너 런타임)에 컨테이너 작성을 의뢰
6. Docker(컨테이너 런타임)에 의해 Nginx콘테이너가 작성됨

### 예시2 : Pod를 외부에 공개하는 등 서비스 리소스 만들 때

1. PC에서 api-server에 Service 구성을 의뢰(kubectl / API)
2. controller-manager이 감지 → 별도 api 호출
3. kube-proxy가 api server를 체크 → service 작성 의뢰를 취득
4. kube-proxy가 iptable에 외부공개를 위한 엔드포인트 및 부하 분산을 추가함.

# 2. Container (コンテナ)

애플리케이션 동작에 필요한 프로그램과 설정 파일 등을 하나로 한 것.

애플리케이션 내의 컨테이너를 교체하는 것으로 **가용성** 및 **아자일**의 특성을 가짐.

- 바꿔야 하는 서비스만 교체하여, 다른 부분을 건들 필요가 없어지기 때문.

※ **애플리케이션**(Application) : 여러 ‘**서비스**’를 **연속**해서 처리하는 것.

kubernetes = **애플리케이션** ↔ **컨테이너 서비스**(구글 단독으로 수십억 개를 제공할 정도로 많음) 간 **연결**을 돕고 **자동화**하는 솔루션

※ 가상 서버(VM)와 컨테이너의 차이 : 

1. 가상 서버 : 서비스가 각각 OS를 점유함. 재기동 시 OS부팅에 시간 소요. 서버 환경은 공유.
2. 컨테이너 :  서버 환경에 더해 OS도 공유. 컨테이너 내에 OS는 포함되어있지 않음.

---

# 3. Docker

OS 상에서 **격리된 실행 환경**(Container)를 만드는 소프트웨어 플래폼.

컨테이너 관리 **소프트웨어**(**コンテナ―エンジン**)의 일종. 컨테이너들이 서버환경, OS와 함께 공유하고 있는 요소.

가상 서버의 Hypervisor(하이퍼바이저, ハイパーバイザー)와 같은 역할.

- 소프트웨어를 “**Container**”라는 표준화된 유닛으로 패키지화.
    - Container에는 라이브러리 / 시스템 툴 / 코드 / 런타임 등 소프트웨어 실행에 필요한 것이 포함.
- 환경에 관계 없이 애플리케이션을 빠르게 구축/테스트/Deployment/스케일/실행 할 수 있게 됨.
- Container에 대한 오퍼레이팅 시스템
    - 커맨드로 컨테이너 구축/개시/정지
- Image / Instance 로 구성

※ **격리된 실행 환경**?

- Docker 컨테이너를 사용하는 것으로, 호스트OS와 별도 **PID**체계, 별도 **파일 시스템**을 가짐.
    - **PID**(Process ID) : Linux에서는 PID 1번인 “/init”(親プロセッサ) 휘하에 모든 프로세스가 존재. 별도의 PID체계를 갖는다는 것은, /init 휘하의 특정 프로세스를 **PID 1번**인 것으로 취급하여, 컨테이너 내에서 “**/init**”(**親プロセッサ**)**인 것처럼** 보이게 함.
    - **파일 시스템** : 호스트OS의 root디렉토리(Linux의 **최상위 디렉토리**) 하에 다른 디렉토리를 만들고, 컨테이너로 기동하는 프로세스에서는 그 디렉토리가 **root디렉토리인 것처럼** 보이게 함.  (root 밖 또는 상위 디렉토리에는 간섭할 수 없게 함.)
- 다른 컨테이너 및 호스트OS에 간섭할 수 없음.

## 3-1. Image (イメージ)

컨테이너의 템플릿 같은 것. 호스트OS 상에 있는 디렉토리를 의미.

- 소프트웨어가 들어가 있음 : 리눅스의 기존 소프트웨어는 의존하는 패키지, 디렉토리, 셋업을 해야 하는 등 설정이 번거로웠으나, **컨테이너 이미지**는 패키지 의존 관계 / 인스톨 작업 등을 모두 끝낸 상태의 파일 시스템을 가지고 있음. 그대로 기동하는 상태.

## 3-2. Instance (インスタンス)

실제로 실행되는 환경. 호스트OS 상의 이미지에서 만들어진 파일시스템. (Linux의 각종 카넬 리소스 등)

- Docker 사용 시, 하나의 이미지에서 여러 인스턴스를 기동할 수 있음.

# 4. 기타

- AWS 인터넷 게이트웨이 : 퍼블릭 IP 주소와 프라이베이트 IP 주소 간을 변환하는 역할
- Amazon S3(Simple Storage Service) : 데이터 보존 서비스